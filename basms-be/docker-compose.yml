version: '3.8'

services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: basms-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: basms
      MYSQL_USER: basms_user
      MYSQL_PASSWORD: ${MYSQL_USER_PASSWORD}
    command: >
      --default-authentication-plugin=mysql_native_password
      --max-connections=100
      --max-connect-errors=10
      --local-infile=0
      --skip-name-resolve
      --skip-symbolic-links
    ports:
      - "127.0.0.1:3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d:ro
    networks:
      - basms-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "basms_user", "-p${MYSQL_USER_PASSWORD}"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 40s

  # RabbitMQ
  rabbitmq:
    image: rabbitmq:3-management
    container_name: basms-rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USERNAME}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - basms-network

  # Users API
  users-api:
    build:
      context: .
      dockerfile: Users.API/Dockerfile
    container_name: basms-users-api
    restart: unless-stopped
    ports:
      - "5001:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - DB_CONNECTION_STRING_USERS=${DB_CONNECTION_STRING_USERS}
      - JwtSettings__SecretKey=${JWT_SECRET_KEY}
      - JwtSettings__Issuer=${JWT_ISSUER}
      - JwtSettings__Audience=${JWT_AUDIENCE}
      - RABBITMQ_HOST=${RABBITMQ_HOST}
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - FIREBASE_API_KEY=${FIREBASE_API_KEY}
      - FIREBASE_URL=${FIREBASE_URL}
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS}
      - EmailSettings__Sender=${EMAIL_SENDER}
      - EmailSettings__Password=${EMAIL_PASSWORD}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
    volumes:
      # Mount Firebase credentials từ VPS vào container
      - ~/basms/config/firebase-credentials.json:/app/config/firebase-credentials.json:ro
    depends_on:
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_started
    networks:
      - basms-network

  # Contracts API
  contracts-api:
    build:
      context: .
      dockerfile: Contracts.API/Dockerfile
    container_name: basms-contracts-api
    restart: unless-stopped
    ports:
      - "5002:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - DB_CONNECTION_STRING_CONTRACTS=${DB_CONNECTION_STRING_CONTRACTS}
      - Jwt__Key=${JWT_SECRET_KEY}
      - Jwt__Issuer=${JWT_ISSUER}
      - Jwt__Audience=${JWT_AUDIENCE}
      - RABBITMQ_HOST=${RABBITMQ_HOST}
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - AWS_BUCKET_NAME=${AWS_BUCKET_NAME}
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY=${AWS_ACCESS_KEY}
      - AWS_SECRET_KEY=${AWS_SECRET_KEY}
      - SIGNATURE_CERT_PATH=${SIGNATURE_CERT_PATH}
      - SIGNATURE_CERT_PASSWORD=${SIGNATURE_CERT_PASSWORD}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - EmailSettings__Sender=${EMAIL_SENDER}
      - EmailSettings__Password=${EMAIL_PASSWORD}
      - HERE_API_KEY=${HERE_API_KEY}
    depends_on:
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_started
    networks:
      - basms-network

  # Shifts API
  shifts-api:
    build:
      context: .
      dockerfile: Shifts.API/Dockerfile
    container_name: basms-shifts-api
    restart: unless-stopped
    ports:
      - "5003:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - DB_CONNECTION_STRING_SHIFTS=${DB_CONNECTION_STRING_SHIFTS}
      - Jwt__Key=${JWT_SECRET_KEY}
      - Jwt__Issuer=${JWT_ISSUER}
      - Jwt__Audience=${JWT_AUDIENCE}
      - RABBITMQ_HOST=${RABBITMQ_HOST}
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - EmailSettings__Sender=${EMAIL_SENDER}
      - EmailSettings__Password=${EMAIL_PASSWORD}
    depends_on:
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_started
    networks:
      - basms-network

  # Attendances API
  attendances-api:
    build:
      context: .
      dockerfile: Attendances.API/Dockerfile
    container_name: basms-attendances-api
    restart: unless-stopped
    ports:
      - "5004:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - DB_CONNECTION_STRING_ATTENDANCES=${DB_CONNECTION_STRING_ATTENDANCES}
      - Jwt__Key=${JWT_SECRET_KEY}
      - Jwt__Issuer=${JWT_ISSUER}
      - Jwt__Audience=${JWT_AUDIENCE}
      - RABBITMQ_HOST=${RABBITMQ_HOST}
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - AWS__Region=${AWS_REGION}
      - AWS__S3__BucketName=${AWS_BUCKET_FACEID_NAME}
      - FaceRecognitionApi__BaseUrl=${FACE_RECOGNITION_API_URL}
    depends_on:
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_started
    networks:
      - basms-network

  # Chats API
  chats-api:
    build:
      context: .
      dockerfile: Chats.API/Dockerfile
    container_name: basms-chats-api
    restart: unless-stopped
    ports:
      - "5005:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - DB_CONNECTION_STRING_CHATS=${DB_CONNECTION_STRING_CHATS}
      - Jwt__Key=${JWT_SECRET_KEY}
      - Jwt__Issuer=${JWT_ISSUER}
      - Jwt__Audience=${JWT_AUDIENCE}
      - RABBITMQ_HOST=${RABBITMQ_HOST}
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - AWS_REGION=${AWS_REGION}
      - AWS_BUCKET_NAME=${AWS_BUCKET_FILE_NAME}
      - AWS_ACCESS_KEY=${AWS_ACCESS_KEY}
      - AWS_SECRET_KEY=${AWS_SECRET_KEY}
    depends_on:
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_started
    networks:
      - basms-network

  # Incidents API
  incidents-api:
    build:
      context: .
      dockerfile: Incidents.API/Dockerfile
    container_name: basms-incidents-api
    restart: unless-stopped
    ports:
      - "5006:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - DB_CONNECTION_STRING_INCIDENTS=${DB_CONNECTION_STRING_INCIDENTS}
      - Jwt__Key=${JWT_SECRET_KEY}
      - Jwt__Issuer=${JWT_ISSUER}
      - Jwt__Audience=${JWT_AUDIENCE}
      - RABBITMQ_HOST=${RABBITMQ_HOST}
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - AWS_REGION=${AWS_REGION}
      - AWS_BUCKET_NAME=${AWS_BUCKET_FILE_NAME}
      - AWS_ACCESS_KEY=${AWS_ACCESS_KEY}
      - AWS_SECRET_KEY=${AWS_SECRET_KEY}
    depends_on:
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_started
    networks:
      - basms-network

volumes:
  mysql_data:

networks:
  basms-network:
    driver: bridge