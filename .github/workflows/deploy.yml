name: Deploy to VPS

on:
  push:
    branches: [ feature ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          echo "Validating required secrets..."
          MISSING_SECRETS=""

          [ -z "$ALLOWED_ORIGINS" ] && MISSING_SECRETS="$MISSING_SECRETS ALLOWED_ORIGINS"
          [ -z "$DB_CONNECTION_STRING_USERS" ] && MISSING_SECRETS="$MISSING_SECRETS DB_CONNECTION_STRING_USERS"
          [ -z "$JWT_SECRET_KEY" ] && MISSING_SECRETS="$MISSING_SECRETS JWT_SECRET_KEY"
          [ -z "$RABBITMQ_HOST" ] && MISSING_SECRETS="$MISSING_SECRETS RABBITMQ_HOST"

          if [ -n "$MISSING_SECRETS" ]; then
            echo "ERROR: Missing required secrets:$MISSING_SECRETS"
            echo "Please set these secrets in GitHub repository settings"
            exit 1
          fi

          echo "✅ All required secrets are set"
        env:
          ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS }}
          DB_CONNECTION_STRING_USERS: ${{ secrets.DB_CONNECTION_STRING_USERS }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          RABBITMQ_HOST: ${{ secrets.RABBITMQ_HOST }}

      - name: Create Firebase credentials JSON file
        run: |
          cd basms-be

          python3 << 'PYTHON_SCRIPT'
          import json
          import os

          firebase_creds = {
              "type": "service_account",
              "project_id": os.environ.get('FIREBASE_PROJECT_ID', ''),
              "private_key_id": os.environ.get('FIREBASE_PRIVATE_KEY_ID', ''),
              "private_key": os.environ.get('FIREBASE_PRIVATE_KEY', '').replace('\\n', '\n'),
              "client_email": os.environ.get('FIREBASE_CLIENT_EMAIL', ''),
              "client_id": os.environ.get('FIREBASE_CLIENT_ID', ''),
              "auth_uri": "https://accounts.google.com/o/oauth2/auth",
              "token_uri": "https://oauth2.googleapis.com/token",
              "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
              "client_x509_cert_url": os.environ.get('FIREBASE_CLIENT_CERT_URL', '')
          }

          with open('firebase-credentials.json', 'w') as f:
              json.dump(firebase_creds, f, indent=2)

          print("✅ Firebase credentials file created successfully")
          PYTHON_SCRIPT

          if [ -f firebase-credentials.json ]; then
            echo "✅ firebase-credentials.json created"
            FILE_SIZE=$(wc -c < firebase-credentials.json)
            echo "File size: $FILE_SIZE bytes"

            if grep -q "BEGIN PRIVATE KEY" firebase-credentials.json; then
              echo "✅ Private key format is correct"
            else
              echo "❌ ERROR: Private key format is incorrect!"
              exit 1
            fi
          else
            echo "❌ ERROR: firebase-credentials.json not created!"
            exit 1
          fi
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_PRIVATE_KEY_ID: ${{ secrets.FIREBASE_PRIVATE_KEY_ID }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_CLIENT_ID: ${{ secrets.FIREBASE_CLIENT_ID }}
          FIREBASE_CLIENT_CERT_URL: ${{ secrets.FIREBASE_CLIENT_CERT_URL }}

      - name: Create .env file for Docker Compose
        run: |
          cd basms-be

          # Create .env file with quoted values to prevent Docker Compose template parsing issues
          cat > .env.production <<'ENVEOF'
          MYSQL_ROOT_PASSWORD="__MYSQL_ROOT_PASSWORD__"
          MYSQL_USER_PASSWORD="__MYSQL_USER_PASSWORD__"
          DB_CONNECTION_STRING_USERS="__DB_CONNECTION_STRING_USERS__"
          DB_CONNECTION_STRING_CONTRACTS="__DB_CONNECTION_STRING_CONTRACTS__"
          DB_CONNECTION_STRING_SHIFTS="__DB_CONNECTION_STRING_SHIFTS__"
          FIREBASE_API_KEY="__FIREBASE_API_KEY__"
          FIREBASE_URL="__FIREBASE_URL__"
          EMAIL_SENDER="__EMAIL_SENDER__"
          EMAIL_PASSWORD="__EMAIL_PASSWORD__"
          JWT_SECRET_KEY="__JWT_SECRET_KEY__"
          JWT_ISSUER="__JWT_ISSUER__"
          JWT_AUDIENCE="__JWT_AUDIENCE__"
          RABBITMQ_HOST="rabbitmq"
          RABBITMQ_USERNAME="__RABBITMQ_USERNAME__"
          RABBITMQ_PASSWORD="__RABBITMQ_PASSWORD__"
          AWS_BUCKET_NAME="__AWS_BUCKET_NAME__"
          AWS_REGION="__AWS_REGION__"
          AWS_ACCESS_KEY="__AWS_ACCESS_KEY__"
          AWS_SECRET_KEY="__AWS_SECRET_KEY__"
          SIGNATURE_CERT_PATH="__SIGNATURE_CERT_PATH__"
          SIGNATURE_CERT_PASSWORD="__SIGNATURE_CERT_PASSWORD__"
          HERE_API_KEY="__HERE_API_KEY__"
          ALLOWED_ORIGINS="__ALLOWED_ORIGINS__"
          GOOGLE_APPLICATION_CREDENTIALS="/app/config/firebase-credentials.json"
          ENVEOF

          # Strip leading whitespace
          sed -i 's/^[[:space:]]*//' .env.production

          # Replace placeholders with actual values (escaped for sed)
          sed -i "s|__MYSQL_ROOT_PASSWORD__|${MYSQL_ROOT_PASSWORD}|g" .env.production
          sed -i "s|__MYSQL_USER_PASSWORD__|${MYSQL_USER_PASSWORD}|g" .env.production
          sed -i "s|__DB_CONNECTION_STRING_USERS__|${DB_CONNECTION_STRING_USERS}|g" .env.production
          sed -i "s|__DB_CONNECTION_STRING_CONTRACTS__|${DB_CONNECTION_STRING_CONTRACTS}|g" .env.production
          sed -i "s|__DB_CONNECTION_STRING_SHIFTS__|${DB_CONNECTION_STRING_SHIFTS}|g" .env.production
          sed -i "s|__FIREBASE_API_KEY__|${FIREBASE_API_KEY}|g" .env.production
          sed -i "s|__FIREBASE_URL__|${FIREBASE_URL}|g" .env.production
          sed -i "s|__EMAIL_SENDER__|${EMAIL_SENDER}|g" .env.production
          sed -i "s|__EMAIL_PASSWORD__|${EMAIL_PASSWORD}|g" .env.production
          sed -i "s|__JWT_SECRET_KEY__|${JWT_SECRET_KEY}|g" .env.production
          sed -i "s|__JWT_ISSUER__|${JWT_ISSUER}|g" .env.production
          sed -i "s|__JWT_AUDIENCE__|${JWT_AUDIENCE}|g" .env.production
          sed -i "s|__RABBITMQ_USERNAME__|${RABBITMQ_USERNAME}|g" .env.production
          sed -i "s|__RABBITMQ_PASSWORD__|${RABBITMQ_PASSWORD}|g" .env.production
          sed -i "s|__AWS_BUCKET_NAME__|${AWS_BUCKET_NAME}|g" .env.production
          sed -i "s|__AWS_REGION__|${AWS_REGION}|g" .env.production
          sed -i "s|__AWS_ACCESS_KEY__|${AWS_ACCESS_KEY}|g" .env.production
          sed -i "s|__AWS_SECRET_KEY__|${AWS_SECRET_KEY}|g" .env.production
          sed -i "s|__SIGNATURE_CERT_PATH__|${SIGNATURE_CERT_PATH}|g" .env.production
          sed -i "s|__SIGNATURE_CERT_PASSWORD__|${SIGNATURE_CERT_PASSWORD}|g" .env.production
          sed -i "s|__HERE_API_KEY__|${HERE_API_KEY}|g" .env.production
          sed -i "s|__ALLOWED_ORIGINS__|${ALLOWED_ORIGINS}|g" .env.production

          echo ".env.production file created"
          echo "Verifying .env.production file..."
          if [ -f .env.production ]; then
            FILE_SIZE=$(wc -c < .env.production)
            echo "File exists, size: $FILE_SIZE bytes"

            if [ "$FILE_SIZE" -lt 100 ]; then
              echo "WARNING: File size is too small! Secrets might be empty."
              echo "Content preview:"
              cat .env.production | sed 's/=.*/=***/'
              exit 1
            fi

            echo "First few lines (masked):"
            head -5 .env.production | sed 's/=.*/=***/'
          else
            echo "ERROR: .env.production file not created!"
            exit 1
          fi
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_USER_PASSWORD: ${{ secrets.MYSQL_USER_PASSWORD }}
          DB_CONNECTION_STRING_USERS: ${{ secrets.DB_CONNECTION_STRING_USERS }}
          DB_CONNECTION_STRING_CONTRACTS: ${{ secrets.DB_CONNECTION_STRING_CONTRACTS }}
          DB_CONNECTION_STRING_SHIFTS: ${{ secrets.DB_CONNECTION_STRING_SHIFTS }}
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_URL: ${{ secrets.FIREBASE_URL }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          JWT_ISSUER: ${{ secrets.JWT_ISSUER }}
          JWT_AUDIENCE: ${{ secrets.JWT_AUDIENCE }}
          RABBITMQ_USERNAME: ${{ secrets.RABBITMQ_USERNAME }}
          RABBITMQ_PASSWORD: ${{ secrets.RABBITMQ_PASSWORD }}
          AWS_BUCKET_NAME: ${{ secrets.AWS_BUCKET_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
          SIGNATURE_CERT_PATH: ${{ secrets.SIGNATURE_CERT_PATH }}
          SIGNATURE_CERT_PASSWORD: ${{ secrets.SIGNATURE_CERT_PASSWORD }}
          HERE_API_KEY: ${{ secrets.HERE_API_KEY }}
          ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS }}

      - name: Create deployment package
        run: |
          tar -czf basms-backend.tar.gz \
            --exclude='basms-be/bin' \
            --exclude='basms-be/obj' \
            --exclude='basms-be/.git' \
            --exclude='basms-be/.vs' \
            --exclude='basms-be/*.user' \
            --exclude='basms-be/publish' \
            --exclude='basms-be/**/bin' \
            --exclude='basms-be/**/obj' \
            --exclude='basms-be/compose.yaml' \
            -C basms-be .
          echo "Deployment package created: basms-backend.tar.gz"

      - name: Upload to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          source: "basms-backend.tar.gz"
          target: "/tmp/"

      - name: Deploy on VPS with Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          script: |
            echo "Starting deployment on VPS..."

            mkdir -p ~/basms

            if [ -d ~/basms/old ]; then
              rm -rf ~/basms/old
            fi
            if [ -d ~/basms/current ]; then
              mv ~/basms/current ~/basms/old
            fi

            mkdir -p ~/basms/current

            cd ~/basms/current
            tar -xzf /tmp/basms-backend.tar.gz

            if [ -f compose.yaml ]; then
              echo "Removing compose.yaml to avoid conflict with docker-compose.yml"
              rm -f compose.yaml
            fi

            if [ -f .env.production ]; then
              mv .env.production .env
              echo ".env file created from .env.production"
              echo "File size: $(wc -c < .env) bytes"
              echo "Number of variables: $(grep -c '=' .env || echo 0)"

              echo "Verifying critical environment variables..."
              for var in ALLOWED_ORIGINS DB_CONNECTION_STRING_USERS JWT_SECRET_KEY RABBITMQ_HOST GOOGLE_APPLICATION_CREDENTIALS; do
                if grep -q "^${var}=" .env; then
                  echo "✅ $var is set"
                else
                  echo "❌ WARNING: $var is missing!"
                fi
              done
            else
              echo "ERROR: .env.production not found!"
              exit 1
            fi

            mkdir -p ~/basms/config

            if [ -f firebase-credentials.json ]; then
              mv firebase-credentials.json ~/basms/config/
              echo "✅ Firebase credentials moved to ~/basms/config/"

              if grep -q "BEGIN PRIVATE KEY" ~/basms/config/firebase-credentials.json; then
                echo "✅ Firebase credentials file format is correct"
              else
                echo "❌ WARNING: Firebase credentials format might be incorrect!"
              fi
            else
              echo "❌ WARNING: firebase-credentials.json not found!"
            fi

            echo "Stopping and removing existing containers..."
            cd ~/basms/current

            docker compose down --remove-orphans || echo "No compose containers to stop"

            echo "Removing orphan containers..."
            docker ps -a --filter "name=basms-" --format "{{.Names}}" | xargs -r docker rm -f || echo "No orphan containers found"

            echo "Cleaning up old Docker images..."
            docker image prune -af --filter "until=24h" || true

            echo "=== DEBUG: .env file content (first 5 lines, values masked) ==="
            if [ -f .env ]; then
              head -5 .env | sed 's/=.*/=***/'
            else
              echo "ERROR: .env file not found!"
              exit 1
            fi

            echo "Building Docker images..."
            docker compose build --no-cache

            echo "Starting services with Docker Compose..."
            docker compose --env-file .env up -d --remove-orphans

            echo "Waiting for services to start..."
            sleep 10

            echo "Service status:"
            docker compose ps

            echo "Recent logs:"
            docker compose logs --tail=50

            rm -f /tmp/basms-backend.tar.gz
            echo "Deployment completed successfully!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment to VPS completed successfully!"
          else
            echo "❌ Deployment failed! Please check the logs."
          fi
